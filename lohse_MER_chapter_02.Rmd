---
title: "Chapter 2: Mixed-Effects Models for Factorial Designs"
author: "Keith Lohse, PhD, PStat"
date: "1/30/2020"
output:
  html_document:
    df_print: paged
---

# Mixed-Effect Models as an Analogue for Multi-Factorial ANOVA

For these examples, we are going to work with a fictional data that that has two 
fully nested (i.e., between-subjects) and two fully crossed (i.e., within-subject)
factors. We have two hypothetical groups of older adults (OA, >65 y) and younger 
adults (YA, <35 y). Within each of those groups, half of the participants were
in the control group (C) and half were in the treatment group (T). Each participant 
was also measured at three different times (1 to 3) in three different conditions 
(A, B, and C). The first ten rows of these data can be seen below. 


```{r, setting libraries, results="hide", message = FALSE}
library(tidyverse); library(RCurl); library(ez); library(lme4); library(lmerTest)

DATA <- read.csv("https://raw.githubusercontent.com/keithlohse/mixed_effects_models/master/data_example.csv")

```

``` {r, print data to screen}
head(DATA, 10)

```

Because we will want to ignore each of the within-subject variables at different 
times, we will want to average across trials to create a data set with one 
observation per condition (data_COND), and we will want to average across conditions
to create a data set with one observation at each time (data_TIME).

Averaging across time, here are the first ten rows of data_COND. 
```{r, subsetting data by condition}
data_COND <- aggregate(speed ~ subID + condition + age_group + group, data=DATA, FUN=mean)
data_COND <- data_COND %>% arrange(subID, age_group, group, condition)
head(data_COND, 10)
```

Averaging across condiitons, here are the first ten rows of data_TIME. 
``` {r, subsetting data by time}
data_TIME <- aggregate(speed ~ subID + time + age_group + group, data=DATA, FUN=mean)
data_TIME <- data_TIME %>% arrange(subID, age_group, group, time)
head(data_TIME)
```

# One-Way Repeated Measures ANOVA (A Single Crossed Factor)
For this example, we will focus on only the effect of condition, so we will use 
the data_COND dataset to average across different trials. First, let's plot the 
data to get a better sense of what our data are saying. 


``` {r plotting the effects of condition, echo=TRUE}
ggplot(data_COND, aes(x = condition, y = speed)) +
  geom_point(aes(fill=condition), pch=21, size=2,
             position=position_jitter(w=0.2, h=0))+
  geom_boxplot(aes(fill=condition), col="black", outlier.shape = "na",
               alpha=0.4, width=0.5)+
  scale_x_discrete(name = "Condition") +
  scale_y_continuous(name = "Speed (m/s)", limits = c(0,3)) +
  theme(axis.text=element_text(size=16, color="black"), 
        axis.title=element_text(size=16, face="bold"),
        plot.title=element_text(size=16, face="bold", hjust=0.5),
        panel.grid.minor = element_blank(),
        strip.text = element_text(size=16, face="bold"),
        legend.position = "none")
  
```

## As an ANOVA...
To implement a simple one-way repeated measures ANOVA, we have a few options. We 
could directly code our ANOVA using the aov() function in R:
``` {r one way ANOVA the hard way, echo=TRUE}
summary(aov(speed ~ condition + Error(subID/condition), data=data_COND))
```

Or we can use the ezANOVA() function from the "ez" package. 
```{r one way ANOVA the ez way, echo=TRUE}
ezANOVA(data = data_COND, 
    dv = .(speed),
    wid = .(subID),
    within = .(condition)
)
```
Although these two different functions present the results in a slightly different
ways, not that the f-values for the two different omnibus tests match. By either 
method, the f-observed for the main-effect of condition is F(2,158) = 68.86, p < 0.001. 

If you are familiar with issues of contrast versus treatment coding, Type I
versus Type III sums of squared errors, and colinearity then directly controlling
your own ANOVA using base R is probably a safe bet. If you are not familiar with
those terms/issues, that the ezANOVA code is probably the best solution for a quick
fix, but I would strongly encourage you to development a more detailed understanding
of general-linear models before jumping into mixed-effect models. 


## One-way RM ANOVA as a mixed-effect model...
Because we only have a single within-subject factor, we will only need to add a 
random-effect of subject to account for individual differences between subjects.
By partitioning the between-subjects variance out of our model, we can fairly test
the effect of condition, because our residuals will now be independent of each
other. 
```{r one way another in a mixed effects model, echo=TRUE}
# First we will define our model
mod1 <- lmer(speed ~ condition + (1|subID), data=data_COND)

# We can then get the ANOVA results for our model:
anova(mod1)
```

If we want to delve deeper into our model, we can also use the summary() function
to get more information about model fit statistics, parameter estimates, random-effects
and residuals. 

```{r}
summary(mod1)
```







# Two-Way Repeated Measures ANOVA (Multiple Crossed Factors)
For this example, we will be analyzing both Time and Condition, so we will use 
our original full data framge, DATA. First, let's plot the data to get a better 
sense of what our data look like.

``` {r plotting two repeated measures}
ggplot(DATA, aes(x = as.factor(time), y = speed)) +
  geom_point(aes(fill=condition), pch=21, size=2,
             position=position_jitterdodge(dodge.width = 0.5))+
  geom_boxplot(aes(fill=condition), col="black", outlier.shape = "na",
               alpha=0.4, width=0.5)+
  scale_x_discrete(name = "Time") +
  scale_y_continuous(name = "Speed (m/s)", limits = c(0,3)) +
  theme(axis.text=element_text(size=16, color="black"), 
        axis.title=element_text(size=16, face="bold"),
        plot.title=element_text(size=16, face="bold", hjust=0.5),
        panel.grid.minor = element_blank(),
        strip.text = element_text(size=16, face="bold"),
        legend.position = "right")
``` 


## As an ANOVA...
Before we run our models, we want to convert time to a factor so that our model
is treating time categorically rather than continuously. (In later modules, we 
will discuss how to mix continuous and categorical factors.) Additionally, remember
that we are now using our larger data set "DATA" rather than our aggregated data
set "data_COND". To implement a two-way repeated measures ANOVA, we have the same 
options as before. We can directly code our ANOVA using the aov() function in R:
``` {r two way ANOVA the hard way, echo=TRUE}
DATA$time <- factor(DATA$time)
summary(aov(speed ~ condition*time + Error(subID/(condition*time)), data=DATA))
```

Or we can use the ezANOVA() function from the "ez" package. 
```{r two way ANOVA the ez way, echo=TRUE}
ezANOVA(data = DATA, 
    dv = .(speed),
    wid = .(subID),
    within = .(time, condition)
)
```
Again, regardless of the coding approach that you use, these two different functions 
produce the same f-observed for the main-effect of time, F(2,158) = 676.1, p < 0.001. 

 


## Two-way RM ANOVA as a mixed-effect model...
Because we now have two crossed factors, we need to not only account for the fact 
that we have multiple observations for each participant, but we need to account 
for multiple observations coming from other factors. For instance, for the effect
of Condition, we actually have condition effects at Time A, Time B, and Time C. 
The converse is also true for the effect of Time, we have effects of Time in
Condition A, Condition B, and Condition C. Thus, in order to appropriately 
account for the statistical dependencies in our data, we need to add random-effects
of "time:subID" and "condition:subID" to the model. 

```{r two way another in a mixed effects model, echo=TRUE}
# First we will define our model
mod1 <- lmer(speed ~ 
               # Fixed Effects:
               time*condition + 
               # Random Effects
               (1|subID)+ (1|time:subID) + (1|condition:subID), 
               # Define your data, 
             data=DATA)

# We can then get the ANOVA results for our model:
anova(mod1)
```

If we want to delve deeper into our model, we can also use the summary() function
to get more information about model fit statistics, parameter estimates, random-effects
and residuals. 

```{r}
summary(mod1)
```